# ETF网格交易策略分析系统 - Kilo Code Rules

## 项目概述

本规则文档定义了ETF网格交易策略分析系统backend的技术架构规范，用于指导AI助手在项目中的开发、维护和扩展工作。

## 1. 架构原则

### 1.1 分层架构原则

- **API层** (`backend/api/`) - 负责HTTP请求处理、路由分发、数据验证
- **服务层** (`backend/services/`) - 业务逻辑协调，不包含算法实现
- **算法层** (`backend/algorithms/`) - 纯算法实现，无业务逻辑
- **配置层** (`backend/config/`) - 统一配置管理
- **模型层** (`backend/models/`) - 数据模型定义和验证
- **工具层** (`backend/utils/`) - 通用工具函数

### 1.2 模块化设计原则

- 每个模块职责单一，边界清晰
- 算法逻辑与业务逻辑严格分离
- 使用依赖注入降低耦合度
- 接口与实现分离

### 1.3 代码组织原则

- 按功能领域组织代码，而非按技术层次
- 保持目录结构扁平化，避免过度嵌套
- 模块间通过清晰的接口通信

## 2. 目录结构规范

### 2.1 标准目录结构

```
backend/
├── app.py                        # Flask应用入口
├── config/                       # 配置管理
│   ├── settings.py              # 主配置类
│   ├── constants.py             # 常量定义
│   ├── validation.py            # 配置验证
│   └── environments/            # 环境配置
├── api/                         # API层
│   ├── routes/                  # 路由模块
│   ├── schemas.py              # 数据模型
│   └── middleware.py           # 中间件
├── services/                    # 业务服务层
│   ├── analysis/               # 分析服务
│   ├── data/                   # 数据服务
│   └── etf/                    # ETF服务
├── algorithms/                  # 算法模块
│   ├── atr/                    # ATR算法
│   └── grid/                   # 网格算法
├── models/                     # 数据模型
├── utils/                      # 工具模块
└── tests/                     # 测试
    ├── unit/                  # 单元测试
    ├── integration/           # 集成测试
    └── fixtures/              # 测试数据
```

### 2.2 文件命名规范

- Python文件使用蛇形命名法：`etf_analysis_service.py`
- 类名使用帕斯卡命名法：`ETFAnalysisService`
- 测试文件前缀：`test_` + 被测试文件名
- 配置文件名：描述性名称 + `.py`

## 3. 编码规范

### 3.1 Python编码规范

- 遵循PEP 8规范
- 使用类型注解
- 函数和类必须有文档字符串
- 导入顺序：标准库 → 第三方库 → 本地模块

### 3.2 错误处理规范

- 使用自定义异常体系
- 异常信息要具体且有帮助
- 在适当的地方捕获和处理异常
- 记录详细的错误日志

### 3.3 日志规范

- 使用结构化日志
- 不同级别日志用于不同目的
- 敏感信息必须脱敏
- 性能关键操作需要记录执行时间

## 4. 依赖管理规则

### 4.1 依赖注入原则

- 服务类通过构造函数接收依赖
- 避免在模块内部创建依赖实例
- 使用接口抽象依赖关系

### 4.2 外部依赖管理

- 使用uv安装和管理依赖
- 同时将生产依赖加入 `requirements.txt`
- 使用版本锁定确保一致性
- 定期更新依赖版本

### 4.3 内部依赖规则

- 上层模块可以依赖下层模块
- 避免循环依赖
- 跨层调用必须通过清晰的接口

## 5. 配置管理规范

### 5.1 配置分层

- 基础配置：`Settings`类
- 环境配置：`DevelopmentSettings`、`ProductionSettings`
- 敏感配置：通过环境变量注入

### 5.2 配置验证

- 使用Pydantic进行配置验证
- 配置项必须有默认值和描述
- 敏感配置必须进行加密或脱敏

### 5.3 环境管理

- 开发环境：调试模式，详细日志
- 测试环境：快速缓存，测试数据
- 生产环境：性能优化，安全配置

## 6. 数据模型规范

### 6.1 模型定义

- 使用Pydantic BaseModel
- 字段必须有类型注解和描述
- 实现数据验证逻辑

### 6.2 序列化规范

- API响应必须使用标准格式
- 敏感字段必须脱敏
- 日期时间使用ISO格式

### 6.3 数据验证

- 输入数据必须验证
- 业务规则必须在模型中体现
- 验证错误信息要具体

## 7. API设计规范

### 7.1 路由设计

- RESTful API设计原则
- URL路径使用名词复数形式
- 版本控制通过URL路径实现

### 7.2 响应格式

```json
{
    "success": true,
    "data": {...},
    "message": "操作成功",
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 7.3 错误响应

```json
{
    "success": false,
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "参数验证失败",
        "details": {...}
    },
    "timestamp": "2024-01-01T00:00:00Z"
}
```

## 8. 算法模块规范

### 8.1 算法实现原则

- 算法模块必须是纯函数
- 不依赖外部状态
- 输入输出明确
- 可测试性强

### 8.2 性能要求

- 算法复杂度要合理
- 大数据量处理要优化
- 缓存计算结果

### 8.3 测试要求

- 算法必须有单元测试
- 测试覆盖率要达到90%以上
- 边界条件要全面测试

## 9. 测试规范

### 9.1 测试结构

```
tests/
├── unit/           # 单元测试
├── integration/    # 集成测试
├── fixtures/       # 测试数据
└── utils/          # 测试工具
```

### 9.2 测试要求

- 每个模块必须有对应的测试
- 测试用例要覆盖正常和异常情况
- 使用Mock对象隔离外部依赖

### 9.3 测试数据

- 测试数据要真实且有代表性
- 敏感数据要使用假数据
- 测试数据要易于维护

## 10. 性能和安全规范

### 10.1 性能要求

- API响应时间 < 2秒
- 算法计算时间要优化
- 内存使用要合理

### 10.2 安全要求

- 输入数据必须验证和清理
- 敏感信息必须加密
- 实现适当的访问控制

### 10.3 监控要求

- 关键操作要记录日志
- 性能指标要监控
- 错误率要统计

## 11. 文档规范

### 11.1 代码文档

- 每个模块必须有文档字符串
- 复杂算法要有详细注释
- API接口要有使用示例

### 11.2 架构文档

- 保持架构图更新
- 记录重要的设计决策
- 维护变更日志

## 12. 开发工作流

### 12.1 代码审查

- 所有代码变更必须经过审查
- 审查要关注架构一致性
- 确保测试覆盖率

### 12.2 版本控制

- 使用语义化版本号
- 提交信息要清晰描述变更
- 分支策略要明确

### 12.3 部署流程

- 自动化测试和部署
- 环境配置要一致
- 回滚机制要完善

## 13. 特殊约束

### 13.1 金融数据约束

- 数据准确性是首要任务
- 计算精度要保证
- 历史数据要完整

### 13.2 外部API约束

- 实现适当的重试机制
- 处理API限流
- 缓存外部数据

### 13.3 业务逻辑约束

- 风险控制逻辑要严谨
- 策略计算要可追溯
- 参数调整要有依据

## 14. 扩展性考虑

### 14.1 新算法集成

- 新算法要实现标准接口
- 不影响现有功能
- 提供配置选项

### 14.2 新数据源集成

- 数据源要抽象化
- 实现统一的数据接口
- 保持数据格式一致性

## 15. 维护指南

### 15.1 代码维护

- 定期重构保持代码质量
- 更新依赖版本
- 修复技术债务

### 15.2 性能优化

- 监控性能指标
- 识别性能瓶颈
- 优化关键路径

### 15.3 问题排查

- 日志要详细且结构化
- 错误信息要有帮助
- 提供诊断工具

---

**最后更新**: 2025-09-25**版本**: 1.0.0**维护者**: AI Assistant

> 注意：本规则文档应与项目代码同步更新，任何架构变更都应反映在相应的规则中。
